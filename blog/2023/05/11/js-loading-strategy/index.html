<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">How Intercode builds and loads JavaScript | Intercode</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="How Intercode builds and loads JavaScript | Intercode"><meta data-rh="true" name="description" content="Intercode is an open source Ruby on Rails application with a (mostly) single-page app frontend. Virtually all &quot;pages&quot; in"><meta data-rh="true" property="og:description" content="Intercode is an open source Ruby on Rails application with a (mostly) single-page app frontend. Virtually all &quot;pages&quot; in"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-05-11T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/nbudin"><meta data-rh="true" property="article:tag" content="tech"><link data-rh="true" rel="icon" href="/img/neilSquare.png"><link data-rh="true" rel="canonical" href="https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy"><link data-rh="true" rel="alternate" href="https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy" hreflang="en"><link data-rh="true" rel="alternate" href="https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://S6GLWS6G10-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy","mainEntityOfPage":"https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy","url":"https://intercode.interactiveliterature.org/blog/2023/05/11/js-loading-strategy","headline":"How Intercode builds and loads JavaScript","name":"How Intercode builds and loads JavaScript","description":"Intercode is an open source Ruby on Rails application with a (mostly) single-page app frontend. Virtually all \"pages\" in","datePublished":"2023-05-11T00:00:00.000Z","author":{"@type":"Person","name":"Nat Budin","url":"https://github.com/nbudin","image":"https://github.com/nbudin.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://intercode.interactiveliterature.org/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Intercode RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Intercode Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Intercode" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.596d853c.css">
<script src="/assets/js/runtime~main.6035d944.js" defer="defer"></script>
<script src="/assets/js/main.5e6206e5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fYrH" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Intercode</b></a><a class="navbar__item navbar__link" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/docs/graphql">GraphQL Reference</a><a class="navbar__item navbar__link" href="/docs/liquid">Liquid Reference</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/neinteractiveliterature/intercode" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OuFA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_w3GN colorModeToggle_XnVY"><button class="clean-btn toggleButton_uEWN toggleButtonDisabled_P_5X" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_BmUR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_djWp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_qD_R"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NODF"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_dHoT thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_id4x margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_IExN">2023</h3><ul class="sidebarItemList_z6tb clean-list"><li class="sidebarItem_NIhr"><a aria-current="page" class="sidebarItemLink_vSot sidebarItemLinkActive_I5ML" href="/blog/2023/05/11/js-loading-strategy">How Intercode builds and loads JavaScript</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_IExN">2022</h3><ul class="sidebarItemList_z6tb clean-list"><li class="sidebarItem_NIhr"><a class="sidebarItemLink_vSot" href="/blog/2022/12/02/database-export-security-disclosure">Database Export Security Issue Disclosure</a></li><li class="sidebarItem_NIhr"><a class="sidebarItemLink_vSot" href="/blog/2022/01/18/graphql-cross-domain-security-issue-disclosure">GraphQL Cross-Domain Security Issue Disclosure</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_IExN">2020</h3><ul class="sidebarItemList_z6tb clean-list"><li class="sidebarItem_NIhr"><a class="sidebarItemLink_vSot" href="/blog/2020/03/15/email-forwarding">Email forwarding</a></li><li class="sidebarItem_NIhr"><a class="sidebarItemLink_vSot" href="/blog/2020/01/27/sms-notifications">SMS Notifications</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_hjF9">How Intercode builds and loads JavaScript</h1><div class="container_zXO5 margin-vert--md"><time datetime="2023-05-11T00:00:00.000Z">May 11, 2023</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_I22Y"><div class="avatar margin-bottom--sm"><a href="https://github.com/nbudin" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_SkUV" src="https://github.com/nbudin.png" alt="Nat Budin"></a><div class="avatar__intro authorDetails_E23J"><div class="avatar__name"><a href="https://github.com/nbudin" target="_blank" rel="noopener noreferrer"><span class="authorName_x4_E">Nat Budin</span></a></div><div class="authorSocials_kHks"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Intercode is an open source Ruby on Rails application with a (mostly) single-page app frontend. Virtually all &quot;pages&quot; in
the web application are resolved and rendered on the frontend using <a href="https://reactrouter.com/" target="_blank" rel="noopener noreferrer">react-router</a>. These
pages then load the data they need using Intercode&#x27;s GraphQL API, which is implemented on the Rails server side using
<a href="https://graphql-ruby.org" target="_blank" rel="noopener noreferrer">graphql-ruby</a>.</p>
<p>Intercode doesn&#x27;t follow the recommended strategy for JavaScript loading in Rails applications. This blog post is an
attempt to explain why, and what we do instead.</p>
<h2 class="anchor anchorWithStickyNavbar_qLr0" id="rails-and-javascript">Rails and JavaScript<a href="#rails-and-javascript" class="hash-link" aria-label="Direct link to Rails and JavaScript" title="Direct link to Rails and JavaScript">​</a></h2>
<p>JavaScript in Rails applications has a long and winding history. This isn&#x27;t a comprehensive timeline, but a basic
outline of how things evolved follows:</p>
<ul>
<li>2005: <a href="https://rubyonrails.org/2005/12/13/rails-1-0-party-like-its-one-oh-oh" target="_blank" rel="noopener noreferrer">The first stable Rails release</a>
came bundled with <a href="http://prototypejs.org/" target="_blank" rel="noopener noreferrer">Prototype.js</a> and <a href="http://script.aculo.us/" target="_blank" rel="noopener noreferrer">Scriptaculous</a>.</li>
<li>2006: <a href="https://rubyonrails.org/2006/3/28/rails-1-1-rjs-active-record-respond_to-integration-tests-and-500-other-things" target="_blank" rel="noopener noreferrer">Rails 1.1</a>
added a feature called &quot;RJS&quot; which allowed Ruby developers to avoid writing JavaScript code for some common
operations. Instead, developers could write Ruby code which generated JavaScript, which would be sent to the browser
and executed on the fly.</li>
<li>2011: <a href="https://rubyonrails.org/2011/5/22/rails-3-1-release-candidate" target="_blank" rel="noopener noreferrer">Rails 3.1</a> introduced the asset pipeline. Based
on a library called Sprockets, the asset pipeline allows Rails applications to preprocess frontend assets such as
JavaScript, CSS, and images. This made it much simpler for Rails applications to use languages that compile to
JavaScript, and Rails encouraged this by recommending <a href="https://coffeescript.org/" target="_blank" rel="noopener noreferrer">CoffeeScript</a> as a default.</li>
<li>2013: <a href="https://rubyonrails.org/2013/6/25/Rails-4-0-final" target="_blank" rel="noopener noreferrer">Rails 4.0</a> introduced new caching features to speed up
server-side rendering and added <a href="https://github.com/turbolinks/turbolinks-classic" target="_blank" rel="noopener noreferrer">Turbolinks</a> as a default for new
applications. The Rails 4.0 release notes explicitly discourage developers from writing single-page apps, instead
recommending these new features as an alternative.</li>
<li>2017: <a href="https://rubyonrails.org/2017/4/27/Rails-5-1-final" target="_blank" rel="noopener noreferrer">Rails 5.1</a> is released, with the headline &quot;Loving
JavaScript.&quot; Along with this release comes <a href="https://github.com/rails/webpacker" target="_blank" rel="noopener noreferrer">Webpacker</a>, a library for driving
Webpack from the Rails server and integrating Webpack with the asset pipeline.</li>
<li>2021: In advance of the release of Rails 7, Rails founder David Heinemeier Hansson announces
<a href="https://world.hey.com/dhh/rails-7-will-have-three-great-answers-to-javascript-in-2021-8d68191b" target="_blank" rel="noopener noreferrer">&quot;three great answers to JavaScript&quot;</a>.
This announcement deprecates Webpacker and encourages developers to try using <a href="https://hotwired.dev/" target="_blank" rel="noopener noreferrer">Hotwire</a>, a
framework that includes a revamped version of Turbolinks and does most rendering on the server side. It also
introduces <a href="https://github.com/rails/jsbundling-rails" target="_blank" rel="noopener noreferrer">jsbundling-rails</a> as a migration path for Webpacker users,
albeit one that loses some functionality, such as the ability to use webpack-dev-server.</li>
</ul>
<p>One consistent theme running throughout this history is that <strong>Rails has tried to make JavaScript as optional as possible</strong>.
This makes sense from a perspective of onboarding new developers: learning Ruby, HTML, and (potentially) CSS is enough
without having to also learn JavaScript.</p>
<p>On the other hand, for Rails developers who have made the choice to embrace a frontend framework such as React, Vue, or
Ember.js, this can make Rails upgrades difficult, particularly in recent years with the introduction and then
deprecation of Webpacker. There are even official forks such as <a href="https://github.com/shakacode/shakapacker" target="_blank" rel="noopener noreferrer">Shakapacker</a>
which aim to provide a smooth path forward for people who built apps on top of Webpacker.</p>
<h2 class="anchor anchorWithStickyNavbar_qLr0" id="going-a-different-way">Going a different way<a href="#going-a-different-way" class="hash-link" aria-label="Direct link to Going a different way" title="Direct link to Going a different way">​</a></h2>
<p>For me, Rails 7 was the culmination of what I saw as a pattern of decades of efforts by the Rails core team to steer
developers away from writing JavaScript frontends for API-only Rails applications. I tried out both jsbundling-rails
and the import maps path outlined in the &quot;three great answers&quot; blog post, and didn&#x27;t find either of them to be great
developer experiences in Intercode. (The blog post pretty much says this is the case for import maps in fully
React-based apps, and for me, the lack of webpack-dev-server support in jsbundling-rails made it significantly slower
and more resource-intensive to develop with.)</p>
<p>What Intercode ideally needed was a solution that:</p>
<ul>
<li>Decouples Rails from the JavaScript frontend as much as possible</li>
<li>Supports a single-repo build and deploy strategy, so that the backend and frontend can be deployed in tandem</li>
<li>Keeps the local development experience responsive and easy to work with</li>
<li>Works well in both a CDN-backed setup as well as a single-server, non-CDN setup (because NEIL&#x27;s installation of
Intercode uses the Amazon CloudFront CDN, but Consequences&#x27; uses a single server)</li>
<li>Allows browser caching to work for compiled JavaScript and CSS bundles</li>
</ul>
<p>Decoupling Rails from the JavaScript frontend would allow us to continue keeping Rails up to date without having to
rethink our JavaScript build strategy every time the Rails core team changed its mind about the best way to integrate
Rails with JavaScript. This was important for us, because Rails updates often contain urgent security fixes and we want
to be able to take those as quickly as possible.</p>
<h2 class="anchor anchorWithStickyNavbar_qLr0" id="without-further-ado">Without further ado<a href="#without-further-ado" class="hash-link" aria-label="Direct link to Without further ado" title="Direct link to Without further ado">​</a></h2>
<p>Here&#x27;s how we do it in Intercode.</p>
<p>Intercode uses plain old off-the-shelf Webpack to build its JavaScript bundles. We use Webpack&#x27;s built-in ability to
add fingerprint hashes to the end of built asset filenames for easy caching, just like what the Rails asset pipeline
does by default.</p>
<p>The only exception to this fingerprint hashing is a small set of JavaScript entry points. Here&#x27;s a slightly abbreviated
version of the section of our webpack.config.js that sets this up:</p>
<div class="language-js codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-js codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token literal-property property" style="color:rgb(12, 150, 155)">entry</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(12, 150, 155)">application</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;./app/javascript/packs/applicationEntry.ts&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&#x27;application-styles&#x27;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;./app/javascript/packs/applicationStyles.ts&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token literal-property property" style="color:rgb(12, 150, 155)">output</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(12, 150, 155)">filename</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;[name].js&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(12, 150, 155)">chunkFilename</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;[name]-[chunkhash].chunk.js&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Because of this configuration, all built JavaScript files will have a chunk hash in the filename, except the
<code>application.js</code> and <code>application-styles.js</code> files. Because of this, Rails doesn&#x27;t need any kind of integration with
Webpack - we can simply hard-code a JavaScript path in our Rails templates. Here&#x27;s an excerpt from our global template:</p>
<div class="language-erb codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-erb codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token plain">&lt;% if ENV[&#x27;ASSETS_HOST&#x27;].present? -%&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  &lt;script type=&quot;application/javascript&quot;&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    window.intercodeAssetsHost = &lt;%=raw ENV[&#x27;ASSETS_HOST&#x27;].to_json %&gt;;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  &lt;/script&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;% end -%&gt;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">&lt;%= javascript_include_tag url_with_possible_host(&#x27;/packs/application.js&#x27;, ENV[&#x27;ASSETS_HOST&#x27;]), defer: true, type: &#x27;module&#x27; %&gt;</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There are a bunch of shenanigans going on here with the asset host, but let&#x27;s simplify this and assume that we&#x27;re using
a simple, single-server Intercode setup. In this setup, the <code>ASSETS_HOST</code> environment variable would not be set.
Effectively, this snippet of template code would behave like this code:</p>
<div class="language-erb codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-erb codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token plain">&lt;%= javascript_include_tag &#x27;/packs/application.js&#x27;, defer: true, type: &#x27;module&#x27; %&gt;</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>No fingerprint needed - all we need to do is have Webpack compile into <code>/public/packs/application.js</code> in the root of the
Rails application, and Rails can hardcode the path to it and serve the files statically.</p>
<p>The actual contents of these entry point files are relatively tiny. Here&#x27;s the effective version of
<code>applicationEntry.ts</code>, with all the code it imports shown inline instead:</p>
<div class="language-ts codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-ts codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">window</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">intercodeAssetsHost</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  __webpack_public_path__ </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(72, 118, 214)">`</span><span class="token template-string string" style="color:rgb(72, 118, 214)">//</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(153, 76, 195)">${</span><span class="token template-string interpolation">window</span><span class="token template-string interpolation punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token template-string interpolation">intercodeAssetsHost</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token template-string string" style="color:rgb(72, 118, 214)">/packs/</span><span class="token template-string template-punctuation string" style="color:rgb(72, 118, 214)">`</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">import</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">/* webpackChunkName: &#x27;applicationStylesheet&#x27; */</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;../styles/application.scss&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">import</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">/* webpackChunkName: &#x27;bootstrap-js&#x27; */</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;bootstrap&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">import</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">/* webpackChunkName: &quot;application-main&quot; */</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;./application&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The heavy lifting here is done by the <code>import</code> function, which is specified in the
<a href="https://tc39.es/proposal-dynamic-import/" target="_blank" rel="noopener noreferrer">ECMAScript Dynamic Import proposal</a> and implemented by Webpack as
<a href="https://webpack.js.org/guides/code-splitting/#dynamic-imports" target="_blank" rel="noopener noreferrer">part of its code splitting features</a>. Behind the
scenes, Webpack adds a small function that allows it to dynamically load other modules on demand, as well as a data
structure that contains the fingerprint hashes of all modules that resulted from this build. This effectively makes
the application entry point into a kind of manifest file that has all the relevant information about the contents of
this Webpack build.</p>
<p>The net effect of this is:</p>
<ol>
<li>Rails renders a hardcoded <code>&lt;script&gt;</code> tag into HTML templates that points at a known, non-fingerprinted location.</li>
<li>The user&#x27;s web browser loads the entry point JS file from that location.</li>
<li>When the entry point JS executes, its dynamic import statements point it at the fingerprinted URLs for the actual
asset bundles for the main application code.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_qLr0" id="caching-and-not-caching">Caching, and not caching<a href="#caching-and-not-caching" class="hash-link" aria-label="Direct link to Caching, and not caching" title="Direct link to Caching, and not caching">​</a></h3>
<p>For this setup to perform well, it&#x27;s very important that two things are true:</p>
<ol>
<li>Asset URLs with fingerprints in them get cached</li>
<li>Asset URLs without fingerprints in them don&#x27;t get cached</li>
</ol>
<p>The reason for caching URLs with fingerprints in them is straightforward: we don&#x27;t want the user to be re-downloading
large chunks of JavaScript and CSS on every page load. The reason for <em>not</em> caching URLs without fingerprints in them
is perhaps less obvious, but it&#x27;s critical for the site to function correctly: if there has been a new deploy of
frontend code, we want users to get the new version the next time they do a page load.</p>
<p>Because the entry point file is effectively a manifest of all built asset hashes, loading the entry point is all that&#x27;s
needed to let the browser do the right thing for loading the rest of the build. If the fingerprints haven&#x27;t changed,
and there&#x27;s already a copy of those files in its local cache, the browser doesn&#x27;t need to do anything - it can use the
copy it&#x27;s already got. If they have changed, the URLs they&#x27;re loaded from have changed and therefore the browser won&#x27;t
use a cached copy.</p>
<p>The tradeoff here is that the entry point file has to be reloaded on every page load. For that reason, we try to keep
it as small as possible. The <a href="https://assets.neilhosting.net/packs/application.js" target="_blank" rel="noopener noreferrer">current production version</a> as of
this writing is a little over 9KB, and if the browser supports gzip compression (which
<a href="https://caniuse.com/sr_content-encoding-gzip" target="_blank" rel="noopener noreferrer">effectively all browsers do</a>) it will only end up transferring around
5KB.</p>
<p>To make sure the entry point files never get cached, we use a small bit of custom Rack middleware in the Rails app:</p>
<div class="language-ruby codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-ruby codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token plain"># adapted from https://stackoverflow.com/a/52848885</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">module Intercode</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  class DisableCachingForSpecificAssets</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    attr_reader :app, :asset_paths</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    def initialize(app, asset_paths)</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      @app = app</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      @asset_paths = Set.new(asset_paths)</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    def call(env)</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      # Let the next middleware classes &amp; app do their thing first…</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      status, headers, response = app.call(env)</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      # …and modify the response if a cache-disabled asset was fetched.</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      if asset_paths.include?(env[&#x27;REQUEST_PATH&#x27;])</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        headers[&#x27;Cache-Control&#x27;] = &#x27;no-cache&#x27;</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        headers.except!(&#x27;Expires&#x27;)</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      [status, headers, response]</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This middleware is loaded in <code>config/environments/production.rb</code>:</p>
<div class="language-ruby codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-ruby codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token plain">if ENV[&quot;RAILS_SERVE_STATIC_FILES&quot;].present?</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  config.middleware.insert_before ActionDispatch::Static,</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">                                  Intercode::DisableCachingForSpecificAssets,</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">                                  JSON.parse(File.read(File.expand_path(&quot;config/nocache-files.json&quot;, Rails.root)))</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code reads a list of paths to disable caching on from <code>config/nocache-files.json</code>, which contains this:</p>
<div class="language-json codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-json codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&quot;/packs/application.js&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;/packs/application-styles.js&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(The reason we split out the list of entry points into a separate JSON file is to support a workflow used by the
Consequences team to support the <a href="https://www.consequences.org.uk/" target="_blank" rel="noopener noreferrer">Consequences larp conventions</a> as well as other
UK-based larp events. This team runs a separate nginx container to serve assets. That workflow needs to dynamically
generate an nginx config file that says which paths to send the <code>Cache-Control: no-cache</code> header on. We want to make
sure that the Rails app and the nginx container stay in sync with one another, so we use the JSON file as a single
source of truth for both of them.)</p>
<h3 class="anchor anchorWithStickyNavbar_qLr0" id="client-auto-reload">Client auto-reload<a href="#client-auto-reload" class="hash-link" aria-label="Direct link to Client auto-reload" title="Direct link to Client auto-reload">​</a></h3>
<p>This setup also enables one other cool feature: it&#x27;s possible for the frontend code in the browser to check whether or
not it&#x27;s running out-of-date JavaScript. We can do this by making a HEAD request to the path of the application.js
entry point:</p>
<div class="language-js codeBlockContainer_obmP theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_HzeS"><pre tabindex="0" class="prism-code language-js codeBlock_BzJz thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_Mbxi"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">const</span><span class="token plain"> response </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(12, 150, 155)">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">fetch</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token template-string template-punctuation string" style="color:rgb(72, 118, 214)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(153, 76, 195)">${</span><span class="token template-string interpolation">__webpack_public_path__ </span><span class="token template-string interpolation operator" style="color:rgb(12, 150, 155)">??</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:rgb(72, 118, 214)">&#x27;/packs/&#x27;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token template-string string" style="color:rgb(72, 118, 214)">application.js</span><span class="token template-string template-punctuation string" style="color:rgb(72, 118, 214)">`</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(12, 150, 155)">method</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;HEAD&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token literal-property property" style="color:rgb(12, 150, 155)">cache</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;no-store&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup_Ivff"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_KjxL" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_iGZS"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_h2lC"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can then use this response to check whether certain headers are the same as the last time we did this request. In
particular, Intercode checks the <code>Last-Modified</code>, <code>ETag</code>, and <code>Content-Length</code> headers of the entry point. If any of
those have changed, it considers the code it&#x27;s running to be outdated. The full implementation of this is a little too
long to paste in here, but <a href="https://github.com/neinteractiveliterature/intercode/blob/07df0692f1b9473510db5a575268ffa74f75d92c/app/javascript/checkAppEntrypointHeadersMatch.ts" target="_blank" rel="noopener noreferrer">here&#x27;s a link to the full implementation</a>.</p>
<p>There are a few situations where Intercode checks whether or not it&#x27;s running outdated code, but the most common one
is during page transitions. We&#x27;ve set up a hook on the React Router location, and whenever it changes, we run this
check. If the code is outdated, we do a <code>window.location.reload()</code>.</p>
<p>Forcing a page reload can be a dangerous operation. If there&#x27;s unsaved data in memory, reloading the page clears it
out. To ensure this is safe in Intercode, we only change the URL location <em>after</em> data has been successfully saved to
the server. For example, when creating a new staff position, the flow goes like this:</p>
<ol>
<li>Go to <code>/staff_positions/new</code>, which renders a blank form for the user to fill out.</li>
<li>The user fills out the form and presses &quot;Submit&quot;.</li>
<li>The frontend code does a GraphQL request using the <code>createStaffPosition</code> mutation.</li>
<li>Only after it returns a successful response, transition to the <code>/staff_positions</code> page.</li>
<li>Because the location is changed, check whether we&#x27;re running outdated code. If so, reload the page.</li>
</ol>
<p>Reloading the page in the last step is safe because we only change locations after the GraphQL request responds
successfully.</p>
<h2 class="anchor anchorWithStickyNavbar_qLr0" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>The approach of using a minimal, uncached, stub entry point with a predictable URL works well for Intercode. With this
strategy, we&#x27;re able to decouple the backend server from the frontend application, ensuring that it&#x27;s possible for us to
upgrade Rails without the possibility of breaking our JavaScript stack.</p>
<p>This approach is probably not right for every web application, or even every Rails application, but I do think it&#x27;s a
useful approach for Rails apps where:</p>
<ul>
<li>The frontend code is largely responsible for rendering HTML, and talks to the server over some kind of API (REST,
GraphQL, etc.)</li>
<li>The frontend code is built using a bundler, such as Webpack, which supports dynamic imports</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_K_cg padding--none margin-left--sm"><li class="tag_GN70"><a class="tag_tYX_ tagRegular_OEHq" href="/blog/tags/tech">tech</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/neinteractiveliterature/intercode/edit/main/doc-site/blog/blog/2023-05-11-js-loading-strategy.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_wisG" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_X715"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2022/12/02/database-export-security-disclosure"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Database Export Security Issue Disclosure</div></a></nav></main><div class="col col--2"><div class="tableOfContents_c6fo thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#rails-and-javascript" class="table-of-contents__link toc-highlight">Rails and JavaScript</a></li><li><a href="#going-a-different-way" class="table-of-contents__link toc-highlight">Going a different way</a></li><li><a href="#without-further-ado" class="table-of-contents__link toc-highlight">Without further ado</a><ul><li><a href="#caching-and-not-caching" class="table-of-contents__link toc-highlight">Caching, and not caching</a></li><li><a href="#client-auto-reload" class="table-of-contents__link toc-highlight">Client auto-reload</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/graphql">GraphQL Schema Reference</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/liquid">Liquid Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://www.neilhosting.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">NEIL Hosting<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OuFA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/neinteractiveliterature/intercode" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_OuFA"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 New England Interactive Literature. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>